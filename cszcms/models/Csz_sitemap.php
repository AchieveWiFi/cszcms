<?php

defined('BASEPATH') OR exit('No direct script access allowed');

class Csz_sitemap extends CI_Model {
    
    function __construct() {
        parent::__construct();
        $this->load->database();
        $this->load->helper('file');
    }
    
    public function runSitemap() {
        $this->genSitemapXML();
        $this->genSitemapHTML();
        $this->genSitemapROR();
        $this->genSitemapTXT();
        $this->genRobotTXT();
    }
    
    public function getFileTime() {
        /* filemtime â€” Gets file modification time */
        $xmlfile = FCPATH."sitemap.xml";
        if (file_exists($xmlfile)) {
            return date("F d Y H:i:s.", filemtime($xmlfile));
        }else{
            return FALSE;
        }
    }
    
    private function genRobotTXT() {
        /* Sitemap Generator for robots.txt */
        $robots_txt = '# robots.txt generated by CSZ CMS'."\n";
        $robots_txt.= 'User-agent: *'."\n";
        $robots_txt.= 'Disallow: /admin/'."\n";
        $robots_txt.= 'Disallow: /install/'."\n";
        $robots_txt.= 'Sitemap: '.BASE_URL.'/sitemap.xml'."\n";
        if($robots_txt){
            $file_path = FCPATH."robots.txt";
            $fopen = fopen($file_path, 'wb') or die("can't open file");
            fwrite($fopen, $robots_txt);
            fclose($fopen);
	}
    }
    
    private function genSitemapXML() {
        /* Sitemap Generator for XML (include article plugin only) */
        $sitemap_xml = '<?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1" xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">'."\n";
        $sitemap_xml.= '<url>
	<loc>'.BASE_URL.'</loc>
	<changefreq>always</changefreq>
        </url>'."\n";
        $lang = $this->Csz_model->getValueArray('lang_iso', 'lang_iso', 'active', 1, 0, 'lang_iso_id', 'ASC');
        if($lang !== FALSE){
            foreach ($lang as $row) {
                $sitemap_xml.= '<url>
                <loc>'.BASE_URL.'/lang/'.$row['lang_iso'].'</loc>
                <changefreq>always</changefreq>
                </url>'."\n";
            }
        }
        $page = $this->Csz_model->getValueArray('page_url', 'pages', 'active', 1, 0, 'page_url', 'ASC');
        if($page !== FALSE){
            foreach ($page as $row) {
                $sitemap_xml.= '<url>
                <loc>'.BASE_URL.'/'.$row['page_url'].'</loc>
                <changefreq>always</changefreq>
                </url>'."\n";
            }
        }
        $menu_other = $this->Csz_model->getValueArray('*', 'page_menu', "active = '1' AND pages_id = '0' AND drop_menu != '1'", '', 0, 'menu_name', 'ASC');
        if($menu_other !== FALSE){
            foreach ($menu_other as $row) {
                $chkotherlink = strpos($row['other_link'], BASE_URL);
                if($row['other_link'] && $chkotherlink !== FALSE){
                    $sitemap_xml.= '<url>
                    <loc>'.$row['other_link'].'</loc>
                    <changefreq>always</changefreq>
                    </url>'."\n";
                }else if($row['plugin_menu']){
                    $sitemap_xml.= '<url>
                    <loc>'.BASE_URL.'/plugin/'.$row['plugin_menu'].'</loc>
                    <changefreq>always</changefreq>
                    </url>'."\n";
                }
            }
        }
        $article = $this->Csz_model->getValueArray('*', 'article_db', "active = '1' AND url_rewrite != ''", '', 0, 'timestamp_update', 'DESC');
        if($article !== FALSE){
            foreach ($article as $row) {
                if($row['is_category']){
                    $sitemap_xml.= '<url>
                    <loc>'.BASE_URL.'/plugin/article/category/'.$row['url_rewrite'].'</loc>
                    <changefreq>always</changefreq>
                    </url>'."\n";
                }else{
                    $sitemap_xml.= '<url>
                    <loc>'.BASE_URL.'/plugin/article/view/'.$row['article_db_id'].'/'.$row['url_rewrite'].'</loc>
                    <changefreq>always</changefreq>
                    </url>'."\n";
                }
            }
        }
        $archive = $this->Csz_model->getValueArray('YEAR(timestamp_create) AS article_year', 'article_db', "is_category = '0' AND active = '1'", '', 0, 'article_year', 'DESC', 'article_year');
        if($archive !== FALSE){
            foreach ($archive as $row) {
                $sitemap_xml.= '<url>
                <loc>'.BASE_URL.'/plugin/article/archive/'.$row['article_year'].'</loc>
                <changefreq>always</changefreq>
                </url>'."\n";
                $subarchive = $this->Csz_model->getValueArray("MONTHNAME(STR_TO_DATE(MONTH(timestamp_create), '%m')) AS article_month_name, MONTH(timestamp_create) AS article_month", 'article_db', "is_category = '0' AND active = '1' AND YEAR(timestamp_create) = '".$row['article_year']."'", '', 0, 'article_month', 'DESC', 'article_month');
                if(!empty($subarchive)){
                    foreach ($subarchive as $sa) {
                        $sitemap_xml.= '<url>
                        <loc>'.BASE_URL.'/plugin/article/archive/'.$row['article_year'].'-'.$sa['article_month'].'</loc>
                        <changefreq>always</changefreq>
                        </url>'."\n";
                    }
                }
            }
        }
        $sitemap_xml.= '</urlset>'."\n";
        if($sitemap_xml){
            $file_path = FCPATH."sitemap.xml";
            $fopen = fopen($file_path, 'wb') or die("can't open file");
            fwrite($fopen, $sitemap_xml);
            fclose($fopen);
	}
    }
    
    private function genSitemapROR() {
        $i = 0;
        $webconfig = $this->Csz_admin_model->load_config();
        /* Sitemap Generator for ROR.XML (include article plugin only) */
        $ror_xml = '<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:ror="http://rorweb.com/0.1/">
        <channel>
        <title>ROR Sitemap for '.BASE_URL.'</title>
        <link>'.BASE_URL.'</link>'."\n";
        $ror_xml.= '<item>
	<link>'.BASE_URL.'</link>
	<title>'.$webconfig->site_name.' | '.$webconfig->keywords.'</title>
	<description>'.$webconfig->site_name.' | '.$webconfig->keywords.'</description>
	<ror:updatePeriod>always</ror:updatePeriod>
	<ror:sortOrder>0</ror:sortOrder>
	<ror:resourceOf>sitemap</ror:resourceOf>
        </item>'."\n";
        $page = $this->Csz_model->getValueArray('*', 'pages', 'active', 1, 0, 'page_url', 'ASC');
        if($page !== FALSE){
            foreach ($page as $row) {
                $i++;
                if($i < 10) $order = 1;
		else if($i < 50) $order = 2;
		else $order = 3;
                $ror_xml.= '<item>
                        <link>'.BASE_URL.'/'.$row['page_url'].'</link>
                        <title>'.$row['page_name'].'</title>
                        <description>'.$row['page_desc'].'</description>
                        <ror:updatePeriod>always</ror:updatePeriod>
                        <ror:sortOrder>'.$order.'</ror:sortOrder>
                        <ror:resourceOf>sitemap</ror:resourceOf>
                </item>'."\n";
            }
        }
        $menu_other = $this->Csz_model->getValueArray('*', 'page_menu', "active = '1' AND pages_id = '0' AND drop_menu != '1'", '', 0, 'menu_name', 'ASC');
        if($menu_other !== FALSE){
            foreach ($menu_other as $row) {
                $i++;
                if($i < 10) $order = 1;
		else if($i < 50) $order = 2;
		else $order = 3;
                $chkotherlink = strpos($row['other_link'], BASE_URL);
                if($row['other_link'] && $chkotherlink !== FALSE){
                    $ror_xml.= '<item>
                        <link>'.$row['other_link'].'</link>
                        <title>'.$row['menu_name'].'</title>
                        <description>'.$row['menu_name'].'</description>
                        <ror:updatePeriod>always</ror:updatePeriod>
                        <ror:sortOrder>'.$order.'</ror:sortOrder>
                        <ror:resourceOf>sitemap</ror:resourceOf>
                    </item>'."\n";
                }else if($row['plugin_menu']){
                    $ror_xml.= '<item>
                        <link>'.BASE_URL.'/plugin/'.$row['plugin_menu'].'</link>
                        <title>'.$row['menu_name'].'</title>
                        <description>'.$row['menu_name'].'</description>
                        <ror:updatePeriod>always</ror:updatePeriod>
                        <ror:sortOrder>'.$order.'</ror:sortOrder>
                        <ror:resourceOf>sitemap</ror:resourceOf>
                    </item>'."\n";
                }
            }
        }
        $article = $this->Csz_model->getValueArray('*', 'article_db', "active = '1' AND url_rewrite != ''", '', 0, 'timestamp_update', 'DESC');
        if($article !== FALSE){
            foreach ($article as $row) {
                $i++;
                if($i < 10) $order = 1;
		else if($i < 50) $order = 2;
		else $order = 3;
                if($row['is_category']){
                    $ror_xml.= '<item>
                        <link>'.BASE_URL.'/plugin/article/category/'.$row['url_rewrite'].'</link>
                        <title>'.$row['category_name'].'</title>
                        <description>'.$row['category_name'].'</description>
                        <ror:updatePeriod>always</ror:updatePeriod>
                        <ror:sortOrder>'.$order.'</ror:sortOrder>
                        <ror:resourceOf>sitemap</ror:resourceOf>
                    </item>'."\n";
                }else{
                    $ror_xml.= '<item>
                        <link>'.BASE_URL.'/plugin/article/view/'.$row['article_db_id'].'/'.$row['url_rewrite'].'</link>
                        <title>'.$row['title'].'</title>
                        <description>'.$row['short_desc'].'</description>
                        <ror:updatePeriod>always</ror:updatePeriod>
                        <ror:sortOrder>'.$order.'</ror:sortOrder>
                        <ror:resourceOf>sitemap</ror:resourceOf>
                    </item>'."\n";
                }
            }
        }
        
        $ror_xml.= '</channel></rss>'."\n";
        if($ror_xml){
            $file_path = FCPATH."ror.xml";
            $fopen = fopen($file_path, 'wb') or die("can't open file");
            fwrite($fopen, $ror_xml);
            fclose($fopen);
	}
    }
    
    private function genSitemapTXT() {
        /* Sitemap Generator for TXT (include article plugin only) */
        $sitemap_txt = BASE_URL.''."\n";
        
        $lang = $this->Csz_model->getValueArray('lang_iso', 'lang_iso', 'active', 1, 0, 'lang_iso_id', 'ASC');
        if($lang !== FALSE){
            foreach ($lang as $row) {
                $sitemap_txt.= BASE_URL.'/lang/'.$row['lang_iso'].''."\n";
            }
        }
        $page = $this->Csz_model->getValueArray('page_url', 'pages', 'active', 1, 0, 'page_url', 'ASC');
        if($page !== FALSE){
            foreach ($page as $row) {
                $sitemap_txt.= BASE_URL.'/'.$row['page_url'].''."\n";
            }
        }
        $menu_other = $this->Csz_model->getValueArray('*', 'page_menu', "active = '1' AND pages_id = '0' AND drop_menu != '1'", '', 0, 'menu_name', 'ASC');
        if($menu_other !== FALSE){
            foreach ($menu_other as $row) {
                $chkotherlink = strpos($row['other_link'], BASE_URL);
                if($row['other_link'] && $chkotherlink !== FALSE){
                    $sitemap_txt.= $row['other_link'].''."\n";
                }else if($row['plugin_menu']){
                    $sitemap_txt.= BASE_URL.'/plugin/'.$row['plugin_menu'].''."\n";
                }
            }
        }
        $article = $this->Csz_model->getValueArray('*', 'article_db', "active = '1' AND url_rewrite != ''", '', 0, 'timestamp_update', 'DESC');
        if($article !== FALSE){
            foreach ($article as $row) {
                if($row['is_category']){
                    $sitemap_txt.= BASE_URL.'/plugin/article/category/'.$row['url_rewrite'].''."\n";
                }else{
                    $sitemap_txt.= BASE_URL.'/plugin/article/view/'.$row['article_db_id'].'/'.$row['url_rewrite'].''."\n";
                }
            }
        }
        $archive = $this->Csz_model->getValueArray('YEAR(timestamp_create) AS article_year', 'article_db', "is_category = '0' AND active = '1'", '', 0, 'article_year', 'DESC', 'article_year');
        if($archive !== FALSE){
            foreach ($archive as $row) {
                $sitemap_txt.= BASE_URL.'/plugin/article/archive/'.$row['article_year'].''."\n";
                $subarchive = $this->Csz_model->getValueArray("MONTHNAME(STR_TO_DATE(MONTH(timestamp_create), '%m')) AS article_month_name, MONTH(timestamp_create) AS article_month", 'article_db', "is_category = '0' AND active = '1' AND YEAR(timestamp_create) = '".$row['article_year']."'", '', 0, 'article_month', 'DESC', 'article_month');
                if(!empty($subarchive)){
                    foreach ($subarchive as $sa) {
                        $sitemap_txt.= BASE_URL.'/plugin/article/archive/'.$row['article_year'].'-'.$sa['article_month'].''."\n";
                    }
                }
            }
        }
        if($sitemap_txt){
            $file_path = FCPATH."urllist.txt";
            $fopen = fopen($file_path, 'wb') or die("can't open file");
            fwrite($fopen, $sitemap_txt);
            fclose($fopen);
	}
    }
    
    private function genSitemapHTML() {
        $webconfig = $this->Csz_admin_model->load_config();
        $sitemap_html = '<!DOCTYPE html>
        <html>
        <head>
        <title>HTML Site Map - Generated by CSZ CMS</title>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width" />
        </head>
        <body>
        <div>
        <h1>HTML Site Map</h1>
        <p>Last updated: '.date("d F Y H:i:s").'</p>
        <table cellpadding="0" cellspacing="0" border="0" width="100%">
        <tr valign="top">
        <td class="lpart" colspan="100">';
        $sitemap_html.= '<h2><a href="'.BASE_URL.'" title="'.$webconfig->site_name.' | '.$webconfig->keywords.'">'.$webconfig->site_name.' | '.$webconfig->keywords.'</a></h2>';
        $page = $this->Csz_model->getValueArray('*', 'pages', 'active', 1, 0, 'page_url', 'ASC');
        if($page !== FALSE){
            foreach ($page as $row) {
                $sitemap_html.= '<p> - <a href="'.BASE_URL.'/'.$row['page_url'].'" title="'.$row['page_name'].'">'.$row['page_name'].'</a></p>';
            }
        }
        $menu_other = $this->Csz_model->getValueArray('*', 'page_menu', "active = '1' AND pages_id = '0' AND drop_menu != '1'", '', 0, 'menu_name', 'ASC');
        if($menu_other !== FALSE){
            foreach ($menu_other as $row) {
                $chkotherlink = strpos($row['other_link'], BASE_URL);
                if($row['other_link'] && $chkotherlink !== FALSE){
                    $sitemap_html.= '<p> - <a href="'.$row['other_link'].'" title="'.$row['menu_name'].'">'.$row['menu_name'].'</a></p>';
                }else if($row['plugin_menu']){
                    $sitemap_html.= '<p> - <a href="'.BASE_URL.'/plugin/'.$row['plugin_menu'].'" title="'.$row['menu_name'].'">'.$row['menu_name'].'</a></p>';
                }
            }
        }
        $article = $this->Csz_model->getValueArray('*', 'article_db', "active = '1' AND url_rewrite != ''", '', 0, 'timestamp_update', 'DESC');
        if($article !== FALSE){
            foreach ($article as $row) {
                if($row['is_category']){
                    $sitemap_html.= '<p> - <a href="'.BASE_URL.'/plugin/article/category/'.$row['url_rewrite'].'" title="'.$row['category_name'].'">'.$row['category_name'].'</a></p>';                    
                }else{
                    $sitemap_html.= '<p> - <a href="'.BASE_URL.'/plugin/article/view/'.$row['article_db_id'].'/'.$row['url_rewrite'].'" title="'.$row['title'].'">'.$row['title'].'</a></p>';                    
                }
            }
        }
        $sitemap_html.= "</td>
        </tr>
        </table>
        </div>
        </div>
        </body>
        </html>";
        if($sitemap_html){
            $file_path = FCPATH."sitemap.html";
            $fopen = fopen($file_path, 'wb') or die("can't open file");
            fwrite($fopen, $sitemap_html);
            fclose($fopen);
	}
    }
    
}